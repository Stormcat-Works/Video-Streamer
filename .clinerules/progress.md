# 進捗記録

## 2025/10/25

### Pythonからの移行と基本機能の実装

*   **Electron/Node.js環境の構築:**
    *   PythonベースのサーバーをElectronデスクトップアプリケーションへ移行するプロジェクトを開始。
    *   `express`を導入し、Electronのメインプロセス内にHTTPサーバーを構築。
    *   フロントエンド（HTML/JS）とバックエンド（`main.ts`）間のIPC通信をセットアップし、UIからサーバーを制御する基本機能（起動・停止）を実装。

*   **初期通信テストの成功:**
    *   最もシンプルな`F`（フルフレーム）形式で固定の単色画像をStormworksクライアントに送信し、基本的な通信を確立。
    *   当初、ES ModuleとCommonJSのモジュール形式のミスマッチによるエラーが発生したが、`tsconfig.json`と`package.json`を修正し、CommonJSに統一することで解決。

### パフォーマンス向上のための段階的なエンコード実装

*   **ビデオファイル処理の実装:**
    *   `fluent-ffmpeg`を導入し、`video.mp4`からフレームを抽出・リサイズ（200x150）して配信するロジックを実装。
    *   Luaスクリプト側の解像度設定も併せて更新。
    *   **結果:** `F`形式のみで、Python版を上回る**CPS 22-25**を達成。

*   **差分（Diff）エンコードの実装:**
    *   直前のフレームとのピクセル差分のみを送信する`D`形式を実装。
    *   `F`形式と`D`形式のデータサイズを比較し、小さい方を動的に選択するロジックを追加。
    *   **結果:** **FPSが1-1.4**に向上し、パフォーマンスが約2倍に改善。

*   **インデックス（Indexed）エンコードの実装:**
    *   フレーム内の色数が256色以下の場合にカラーパレットを利用する`I`（インデックス）形式と`DI`（差分インデックス）形式を実装。
    *   LRUキャッシュロジックを持つ`PaletteManager`を導入し、クライアントとパレット情報を同期。
    *   **結果:** **CPSが24-31**、**FPSが1.3-3.2**まで向上。

*   **RLE（ランレングスエンコーディング）の実装:**
    *   連続する同一データを圧縮する`FR`（フルRLE）形式と`IR`（インデックスRLE）形式を実装。
    *   これにより、仕様書に記載された6種類すべてのエンコード形式の実装が完了。
    *   **結果:** **FPSが4-7.6**まで向上し、コマ送り動画として認識できるレベルのパフォーマンスを達成。
